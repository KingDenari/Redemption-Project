{% extends "base.html" %}
{% block content %}
<div class="container">
  <h2 class="text my-2">Target Your Goals & Conquer!</h2>
  <p class="text">Smart Goals = Success!</p>

  <div class="text mb-4">
    <button id="addTaskBtn" class="btn btn-success">â• Add a Goal & Get Moving!</button>
  </div>

  <div id="taskForm" class="mb-4" style="display: none;">
    <form id="goalForm">
      <div class="form-group">
        <input type="text" class="form-control mb-2" id="goalTitle" placeholder="Enter your goal" required>
        <input type="date" class="form-control mb-2" id="goalDate" required>
        <input type="time" class="form-control mb-2" id="goalTime" required>
        <div class="d-flex justify-content-between">
          <button type="submit" class="btn btn-primary">ğŸ’¾ Save Task</button>
          <button type="button" class="btn btn-secondary" onclick="cancelTask()">âŒ Cancel</button>
        </div>
      </div>
    </form>
  </div>

  <ul id="goalsList" class="list-group"></ul>

  <!-- Completed Goals Section (Initially Hidden) -->
  <div id="completedGoalsSection" class="mt-5" style="display: none;">
    <h4 class="text my-3">Completed Goals ğŸ‰</h4>
    <p class="text">You did it! Every small step leads to something great!</p>
    <button id="toggleCompletedBtn" class="btn btn-info">ğŸ“œ Show Completed Goals</button>
    <ul id="completedGoalsList" class="list-group mt-3"></ul>
  </div>

  <!-- Reward Notification Box (Initially Hidden) -->
  <div id="rewardNotification" class="alert alert-success text-center mt-4" style="display: none;">
    ğŸ‰ Youâ€™ve Completed 5 Goals! ğŸ…  
     ğŸ“· Send a screenshot to claim 1 week of free premium!* to redemptioncutomercare1@gmail.com  
    <button id="closeNotification" class="btn btn-danger btn-sm mt-2">âŒ Dismiss</button>
  </div>
<footer class="text-center mt-5 py-3 bg-light"><p>This version of goals is still being improved.Give suggestions<a href="/feedback"> here</a></p>
  </footer>
</div>

<script>
  let tasks = [];
  let completedCount = 0;

  // Load tasks from localStorage on startup
  window.addEventListener('DOMContentLoaded', () => {
    const savedTasks = localStorage.getItem('user_goals');
    if (savedTasks) {
      tasks = JSON.parse(savedTasks);
      renderTasks();
    }
  });

  function saveTasksToLocalStorage() {
    localStorage.setItem('user_goals', JSON.stringify(tasks));
  }

  function renderTasks() {
    const goalsList = document.getElementById("goalsList");
    const completedGoalsList = document.getElementById("completedGoalsList");
    goalsList.innerHTML = "";
    completedGoalsList.innerHTML = "";
    completedCount = 0;

    tasks.forEach((task, index) => {
      const li = document.createElement("li");
      li.className = "list-group-item d-flex justify-content-between align-items-center";
      
      const taskContent = document.createElement("span");
      if (task.completed) {
        taskContent.style.textDecoration = "line-through";
        completedCount++;
      }
      taskContent.innerHTML = `<strong>${task.title}</strong><br><small>${task.date} at ${task.time}</small>`;
      li.appendChild(taskContent);

      const btnGroup = document.createElement("div");
      let buttonsHtml = "";
      
      if (!task.completed) {
        buttonsHtml += `<button class="btn btn-success btn-sm mr-2" onclick="markDone(${index})">âœ… Done</button>`;
      }
      
      buttonsHtml += `
        <button class="btn btn-warning btn-sm mr-2" onclick="editTask(${index})">âœï¸ Edit</button>
        <button class="btn btn-danger btn-sm" onclick="deleteTask(${index})">ğŸ—‘ï¸ Delete</button>
      `;
      btnGroup.innerHTML = buttonsHtml;
      li.appendChild(btnGroup);

      if (task.completed) {
        completedGoalsList.appendChild(li);
        document.getElementById("completedGoalsSection").style.display = "block";
      } else {
        goalsList.appendChild(li);
      }
    });

    if (completedCount >= 5) {
      document.getElementById("rewardNotification").style.display = "block";
    } else {
      document.getElementById("rewardNotification").style.display = "none";
    }
  }

  document.getElementById("addTaskBtn").addEventListener("click", function () {
    document.getElementById("taskForm").style.display = "block";
  });

  function cancelTask() {
    document.getElementById("goalForm").reset();
    document.getElementById("taskForm").style.display = "none";
  }

  document.getElementById("goalForm").addEventListener("submit", function (e) {
    e.preventDefault();

    const title = document.getElementById("goalTitle").value;
    const date = document.getElementById("goalDate").value;
    const time = document.getElementById("goalTime").value;

    const [year, month, day] = date.split("-");
    const formattedDate = `${day}-${month}-${year}`;

    const newTask = {
      title: title,
      date: formattedDate,
      time: time,
      completed: false
    };

    tasks.push(newTask);
    saveTasksToLocalStorage();
    renderTasks();

    document.getElementById("goalForm").reset();
    document.getElementById("taskForm").style.display = "none";
  });

  function markDone(index) {
    tasks[index].completed = true;
    saveTasksToLocalStorage();
    renderTasks();
  }

  function deleteTask(index) {
    if (confirm("Deleting your goal? Redemption means completingâ€”not escaping!")) {
      tasks.splice(index, 1);
      saveTasksToLocalStorage();
      renderTasks();
    }
  }

  function editTask(index) {
    if (confirm("Trying to edit? Redemption doesnâ€™t rewrite fateâ€”only improves it!")) {
      const task = tasks[index];
      document.getElementById("goalTitle").value = task.title;
      const [day, month, year] = task.date.split("-");
      document.getElementById("goalDate").value = `${year}-${month}-${day}`;
      document.getElementById("goalTime").value = task.time;
      
      // Remove the old task so the user can "save" the new one
      tasks.splice(index, 1);
      document.getElementById("taskForm").style.display = "block";
    }
  }

  document.getElementById("toggleCompletedBtn").addEventListener("click", function () {
    const list = document.getElementById("completedGoalsList");
    list.style.display = list.style.display === "none" ? "block" : "none";
    this.innerText = list.style.display === "none" ? "ğŸ“œ Show Completed Goals" : "ğŸ™Œ Hide Completed Goals";
  });

  document.getElementById("closeNotification").addEventListener("click", function () {
    document.getElementById("rewardNotification").style.display = "none";
  });

</script>

{% endblock %}
